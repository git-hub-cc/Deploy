const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./ImageCropperModal-D31CoGAa.js","./index-dUS5mm6e.js","./index-5uDYxhLe.css","./ImageCropperModal-BpomnhwU.css"])))=>i.map(i=>d[i]);
import{_ as G,r as l,e as I,o as ie,l as p,h as r,j as e,t as k,v as R,y as re,U as ke,x as ce,R as E,A as X,V as Ce,W as P,G as _e,a as we,n as Y,w as ue,k as W,S as de,F as ee,s as me,g as B,K as be,c as $e,I as Le,H as Se,Q as xe,i as Z,m as U,p as M,T as J,z as Ue,X as Ie,Y as Me,Z as Fe}from"./index-dUS5mm6e.js";import{L as x}from"./leaflet-src-B1vOQq_m.js";const Te={class:"form-header"},De={class:"form-body"},Ae={class:"form-group"},Be={class:"coords-display"},Pe={class:"form-group"},Re={class:"form-group"},ze={class:"form-group"},Ne=["src"],Oe={key:1},Ve={class:"form-footer"},je=["disabled"],Ee={__name:"AddLocationForm",props:{coordinates:{type:Object,required:!0}},emits:["submit","cancel","show-cropper"],setup(u,{emit:f}){const h=u,v=f,y=l("ç¾é£Ÿ"),a=l(""),n=l(null),m=l(null),g=l(null),d=I(()=>a.value.trim()&&n.value);function L(){var o;(o=g.value)==null||o.click()}function _(o){if(!o)return;if(!["image/jpeg","image/png","image/webp"].includes(o.type)){X.emit("showNotification",{message:"è¯·ä¸Šä¼  JPG, PNG æˆ– WebP æ ¼å¼çš„å›¾ç‰‡ã€‚",type:"warning"});return}if(o.size>10*1024*1024){X.emit("showNotification",{message:"åŸå§‹å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 10MBã€‚",type:"warning"});return}const t=b=>{n.value=b,m.value&&URL.revokeObjectURL(m.value),m.value=URL.createObjectURL(b)},c=URL.createObjectURL(o);v("show-cropper",{imageSrc:c,fileName:o.name,onComplete:t})}function w(o){_(o.target.files[0]),o.target&&(o.target.value="")}function F(o){_(o.dataTransfer.files[0])}function S(){d.value&&v("submit",{latitude:h.coordinates.lat,longitude:h.coordinates.lng,tag:y.value,description:a.value,imageFile:n.value})}return ie(()=>{m.value&&URL.revokeObjectURL(m.value)}),(o,t)=>(r(),p("div",{class:"add-location-form",onClick:t[5]||(t[5]=E(()=>{},["stop"]))},[e("header",Te,[t[6]||(t[6]=e("h4",null,"æ·»åŠ æ–°åœ°ç‚¹",-1)),e("button",{class:"close-btn",onClick:t[0]||(t[0]=c=>o.$emit("cancel"))},"Ã—")]),e("div",De,[e("div",Ae,[t[7]||(t[7]=e("label",null,"åæ ‡",-1)),e("p",Be,k(u.coordinates.lat.toFixed(6))+", "+k(u.coordinates.lng.toFixed(6)),1)]),e("div",Pe,[t[9]||(t[9]=e("label",{for:"tag-select"},"æ ‡ç­¾",-1)),R(e("select",{id:"tag-select","onUpdate:modelValue":t[1]||(t[1]=c=>y.value=c)},[...t[8]||(t[8]=[ke('<option value="ç¾é£Ÿ" data-v-dee4d0ea>ç¾é£Ÿ</option><option value="æ™¯ç‚¹" data-v-dee4d0ea>æ™¯ç‚¹</option><option value="è´­ç‰©" data-v-dee4d0ea>è´­ç‰©</option><option value="æ´»åŠ¨" data-v-dee4d0ea>æ´»åŠ¨</option><option value="å…¶ä»–" data-v-dee4d0ea>å…¶ä»–</option>',5)])],512),[[re,y.value]])]),e("div",Re,[t[10]||(t[10]=e("label",{for:"desc-textarea"},"æè¿°",-1)),R(e("textarea",{id:"desc-textarea","onUpdate:modelValue":t[2]||(t[2]=c=>a.value=c),rows:"4",placeholder:"åˆ†äº«ä¸€ä¸‹è¿™ä¸ªåœ°æ–¹çš„ç‰¹åˆ«ä¹‹å¤„å§..."},null,512),[[ce,a.value]])]),e("div",ze,[t[11]||(t[11]=e("label",null,"å›¾ç‰‡",-1)),e("div",{class:"image-upload-area",onClick:L,onDragover:t[3]||(t[3]=E(()=>{},["prevent"])),onDrop:E(F,["prevent"])},[e("input",{type:"file",ref_key:"fileInputRef",ref:g,onChange:w,accept:"image/jpeg, image/png, image/webp",hidden:""},null,544),m.value?(r(),p("img",{key:0,src:m.value,alt:"å›¾ç‰‡é¢„è§ˆ",class:"image-preview"},null,8,Ne)):(r(),p("p",Oe,"ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„"))],32)])]),e("footer",Ve,[e("button",{class:"btn-secondary",onClick:t[4]||(t[4]=c=>o.$emit("cancel"))},"å–æ¶ˆ"),e("button",{class:"btn-primary",onClick:S,disabled:!d.value},"æäº¤åˆ†äº«",8,je)])]))}},We=G(Ee,[["__scopeId","data-v-dee4d0ea"]]),Ge=Ce("map",()=>{const u=l([]),f=l(!1);async function h(){if(!f.value){f.value=!0;try{const y=P.getMapLocations(),a=new Promise(m=>setTimeout(m,1e3)),[n]=await Promise.all([y,a]);u.value=n,_e(`æˆåŠŸè·å– ${n.length} ä¸ªåœ°å›¾æ ‡è®°ç‚¹ã€‚`,"INFO")}finally{f.value=!1}}}async function v(y){f.value=!0;try{const a=await P.createMapLocation(y);return a?(u.value.push(a),X.emit("showNotification",{message:"åœ°ç‚¹åˆ†äº«æˆåŠŸï¼",type:"success"}),!0):!1}finally{f.value=!1}}return{locations:u,isLoading:f,fetchLocations:h,addLocation:v}}),qe={class:"comment-item"},He={class:"comment-header"},Ke={class:"comment-author"},Qe={class:"comment-timestamp"},Ze={class:"comment-content"},Je={class:"comment-footer"},Xe={class:"like-icon"},Ye={class:"like-count"},et={__name:"CommentItem",props:{comment:{type:Object,required:!0}},emits:["toggle-like"],setup(u){const f=u,h=we(),v=I(()=>{const a=h.contacts[f.comment.userId];return a?a.name:f.comment.userId===h.userId?h.userName:`ç”¨æˆ· ${f.comment.userId.substring(0,6)}`}),y=I(()=>new Date(f.comment.createdAt).toLocaleString("zh-CN",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}));return(a,n)=>(r(),p("div",qe,[e("div",He,[e("span",Ke,k(v.value),1),e("span",Qe,k(y.value),1)]),e("p",Ze,k(u.comment.content),1),e("div",Je,[e("button",{class:Y(["like-button",{liked:u.comment.likedByCurrentUser}]),onClick:n[0]||(n[0]=m=>a.$emit("toggle-like",u.comment.id))},[e("span",Xe,k(u.comment.likedByCurrentUser?"â¤ï¸":"ğŸ¤"),1),e("span",Ye,k(u.comment.likeCount),1)],2)])]))}},tt=G(et,[["__scopeId","data-v-4576a453"]]),ot={class:"location-panel-root"},at={class:"panel-header"},nt={class:"location-name"},st={class:"location-details-container"},lt=["src","alt"],it={class:"location-text-content"},rt={class:"location-description"},ct={class:"location-creator"},ut={class:"comment-content-wrapper"},dt={key:0,class:"status-overlay"},mt={key:1,class:"status-overlay error"},vt={key:2,class:"status-overlay"},pt={key:3,class:"comment-list scroller"},ft={class:"panel-footer"},gt={class:"comment-input-area"},ht=["disabled"],yt=["disabled"],kt={__name:"CommentModal",props:{locationData:{type:Object,required:!0}},emits:["close"],setup(u,{emit:f}){const h=u,v=I(()=>{var o;return(o=h.locationData)==null?void 0:o.id}),y=I(()=>{var o;return((o=h.locationData)==null?void 0:o.tag)||"åœ°ç‚¹"}),a=l([]),n=l(!0),m=l(null),g=l(""),d=l(!1),L=l(null);function _(){be(()=>{const o=L.value;o&&(o.style.height="auto",o.style.height=`${Math.min(o.scrollHeight,100)}px`)})}async function w(){if(v.value){n.value=!0,m.value=null;try{const o=await P.getCommentsForLocation(v.value);a.value=o}catch{m.value="åŠ è½½è¯„è®ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚"}finally{n.value=!1}}}async function F(){const o=g.value.trim();if(!(!o||!v.value)){d.value=!0;try{const t=await P.addCommentForLocation(v.value,o);if(t){a.value.unshift(t),g.value="",_();const c=document.querySelector(".comment-list");c&&(c.scrollTop=0)}}finally{d.value=!1}}}async function S(o){const t=a.value.findIndex(T=>T.id===o);if(t===-1)return;const c={...a.value[t]};a.value[t].likedByCurrentUser=!c.likedByCurrentUser,a.value[t].likeCount+=c.likedByCurrentUser?-1:1;const b=await P.toggleCommentLike(o);b?(a.value[t].likedByCurrentUser=b.likedByCurrentUser,a.value[t].likeCount=b.newLikeCount):a.value[t]=c}return ue(()=>v.value,(o,t)=>{o&&o!==t&&(a.value=[],g.value="",w())},{immediate:!0}),(o,t)=>(r(),p("div",ot,[e("header",at,[e("h3",nt,k(y.value),1),e("button",{class:"close-btn",onClick:t[0]||(t[0]=c=>o.$emit("close")),title:"å…³é—­"},"Ã—")]),e("div",st,[e("img",{src:`https://ppmc.club/webchat/${u.locationData.imageUrl}`,alt:u.locationData.tag,class:"location-image"},null,8,lt),e("div",it,[e("p",rt,k(u.locationData.description),1),e("small",ct,"ç”± "+k(u.locationData.createdBy)+" åˆ†äº«",1)])]),e("div",ut,[n.value?(r(),p("div",dt,[W(de),t[2]||(t[2]=e("p",null,"æ­£åœ¨åŠ è½½è¯„è®º...",-1))])):m.value?(r(),p("div",mt,[e("p",null,k(m.value),1)])):a.value.length===0?(r(),p("div",vt,[...t[3]||(t[3]=[e("p",null,"è¿˜æ²¡æœ‰è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§ï¼",-1)])])):(r(),p("div",pt,[(r(!0),p(ee,null,me(a.value,c=>(r(),B(tt,{key:c.id,comment:c,onToggleLike:S},null,8,["comment"]))),128))]))]),e("footer",ft,[e("div",gt,[R(e("textarea",{"onUpdate:modelValue":t[1]||(t[1]=c=>g.value=c),placeholder:"å‘è¡¨ä½ çš„çœ‹æ³•...",rows:"1",class:"comment-textarea",disabled:d.value,onInput:_,ref_key:"textareaRef",ref:L},null,40,ht),[[ce,g.value]]),e("button",{class:"btn-primary",onClick:F,disabled:d.value||!g.value.trim()},k(d.value?"...":"å‘è¡¨"),9,yt)])])]))}},Ct=G(kt,[["__scopeId","data-v-998f8550"]]),_t={class:"map-modal-container"},wt={class:"world-map-content"},bt={key:0,class:"status-overlay"},$t={class:"map-footer"},Lt={class:"map-filter-container"},St=["value"],xt={class:"map-search-container"},Ut=["value"],It={key:1,class:"add-mode-hint"},Mt={key:2,class:"no-results-hint"},Ft={__name:"WorldMapModal",setup(u){const f=Me(()=>Fe(()=>import("./ImageCropperModal-D31CoGAa.js"),__vite__mapDeps([0,1,2,3]),import.meta.url)),h=$e(),v=Ge(),y=Le(),a=l(null);let n=null,m=null,g=null;const d=l(!1),L=l(null),_=l(!1),w=l({}),F=I(()=>y.isCallActive&&!y.isFullScreenCallViewVisible),S=l(!1),o=l(null),t=l({top:0,left:0}),c=I(()=>({top:`${t.value.top}px`,left:`${t.value.left}px`}));function b(){S.value=!1,o.value=null}const T={ç¾é£Ÿ:{iconFile:"icons/marker-icon-food.svg"},æ™¯ç‚¹:{iconFile:"icons/marker-icon-scenery.svg"},è´­ç‰©:{iconFile:"icons/marker-icon-shopping.svg"},æ´»åŠ¨:{iconFile:"icons/marker-icon-activity.svg"},å…¶ä»–:{iconFile:"icons/marker-icon-other.svg"}},D=l("all"),z=l(""),te=Ie(s=>{z.value=s.target.value},300),ve=l([{value:"all",text:"å…¨éƒ¨åˆ†ç±»"},...Object.keys(T).map(s=>({value:s,text:s}))]),N={default:x.icon({iconUrl:"icons/marker-icon.svg",shadowUrl:"icons/marker-shadow.svg",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),temp:x.icon({iconUrl:"icons/marker-icon-temp.svg",shadowUrl:"icons/marker-shadow.svg",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]})};for(const s in T)N[s]=x.icon({iconUrl:T[s].iconFile,shadowUrl:"icons/marker-shadow.svg",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});const oe=I(()=>{const s=D.value==="all"?v.locations:v.locations.filter(C=>C.tag===D.value),i=z.value.toLowerCase().trim();return i?s.filter(C=>C.description&&C.description.toLowerCase().includes(i)||C.tag&&C.tag.toLowerCase().includes(i)||C.createdBy&&C.createdBy.toLowerCase().includes(i)):s});function pe(){a.value&&!n&&(n=x.map(a.value).setView([31.2304,121.4737],5),x.tileLayer("https://{s}.ppmc.club/{z}/{x}/{y}.png",{maxZoom:18,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(n),m=x.layerGroup().addTo(n),n.on("click",fe),n.invalidateSize())}function q(){h.hideOverlayModal()}function ae(s){s.key==="Escape"&&(S.value?b():_.value?ne():d.value?O(!1):q())}Se(async()=>{setTimeout(async()=>{pe(),await v.fetchLocations(),n&&n.invalidateSize()},350),window.addEventListener("keydown",ae)}),ie(()=>{window.removeEventListener("keydown",ae),n&&(n.remove(),n=null)}),ue(oe,s=>{!n||!m||(m.clearLayers(),s.forEach(i=>{const C=N[i.tag]||N.default;x.marker([i.latitude,i.longitude],{icon:C}).addTo(m).on("click",se=>{x.DomEvent.stopPropagation(se),o.value=i,S.value=!0;const V=a.value;if(!V)return;const H=n.latLngToContainerPoint(se.latlng),le=350,K=400,j=15;let Q=H.x+j,A=H.y-K/2;Q+le>V.clientWidth&&(Q=H.x-le-j),A<0&&(A=j),A+K>V.clientHeight&&(A=V.clientHeight-K-j),t.value={top:A,left:Q}})}))},{deep:!0});function O(s){d.value=typeof s=="boolean"?s:!d.value,d.value||(g&&(g.remove(),g=null),L.value=null)}function fe(s){S.value&&b(),d.value&&(L.value=s.latlng,g?g.setLatLng(s.latlng):g=x.marker(s.latlng,{icon:N.temp,zIndexOffset:1e3}).addTo(n),n.panTo(s.latlng))}async function ge(s){await v.addLocation(s)&&O(!1)}function he(s){w.value=s,_.value=!0}function ye(s){typeof w.value.onComplete=="function"&&w.value.onComplete(s),_.value=!1,w.value={}}function ne(){_.value=!1,w.value={}}return(s,i)=>{const C=xe("motion-pop");return r(),B(J,{name:"world-map-fade"},{default:Z(()=>[M(h).activeOverlayModal==="worldMap"?(r(),p("div",{key:0,class:Y(["viewer-backdrop",{"widget-active":F.value}]),onClick:E(q,["self"])},[e("button",{class:"close-button",onClick:q,title:"å…³é—­ (Esc)"},"Ã—"),R((r(),p("div",_t,[e("div",wt,[M(v).isLoading&&M(v).locations.length===0?(r(),p("div",bt,[W(de),i[4]||(i[4]=e("p",null,"æ­£åœ¨åŠ è½½åœ°ç‚¹æ•°æ®...",-1))])):U("",!0),e("div",{id:"world-map-container",ref_key:"mapContainerRef",ref:a,class:Y({"add-mode":d.value})},null,2),W(J,{name:"form-fade"},{default:Z(()=>[d.value&&L.value?(r(),B(We,{key:0,coordinates:L.value,onSubmit:ge,onCancel:i[0]||(i[0]=$=>O(!1)),onShowCropper:he},null,8,["coordinates"])):U("",!0)]),_:1}),W(J,{name:"comment-panel-fade"},{default:Z(()=>[S.value&&o.value?(r(),B(Ct,{key:0,"location-data":o.value,style:Ue(c.value),onClose:b},null,8,["location-data","style"])):U("",!0)]),_:1})]),e("footer",$t,[d.value?U("",!0):(r(),p(ee,{key:0},[e("div",Lt,[R(e("select",{"onUpdate:modelValue":i[1]||(i[1]=$=>D.value=$),class:"filter-select"},[(r(!0),p(ee,null,me(ve.value,$=>(r(),p("option",{key:$.value,value:$.value},k($.text),9,St))),128))],512),[[re,D.value]])]),e("div",xt,[e("input",{type:"search",value:z.value,onInput:i[2]||(i[2]=(...$)=>M(te)&&M(te)(...$)),placeholder:"æœç´¢åœ°ç‚¹...",class:"search-input","aria-label":"æœç´¢åœ°ç‚¹"},null,40,Ut)])],64)),d.value?(r(),p("p",It,"è¯·åœ¨åœ°å›¾ä¸Šç‚¹å‡»é€‰æ‹©è¦åˆ†äº«çš„ä½ç½®")):U("",!0),!d.value&&oe.value.length===0&&(D.value!=="all"||z.value!=="")?(r(),p("p",Mt," æ— åŒ¹é…åœ°ç‚¹ ")):U("",!0),i[5]||(i[5]=e("div",{class:"spacer"},null,-1)),e("button",{class:"btn-secondary",onClick:i[3]||(i[3]=$=>O(!d.value))},k(d.value?"å–æ¶ˆæ·»åŠ ":"+ åˆ†äº«åœ°ç‚¹"),1)])])),[[C]]),_.value?(r(),B(M(f),{key:0,"image-src":w.value.imageSrc,"file-name":w.value.fileName,onComplete:ye,onCancel:ne},null,8,["image-src","file-name"])):U("",!0)],2)):U("",!0)]),_:1})}}},At=G(Ft,[["__scopeId","data-v-7ad239d0"]]);export{At as default};
