import{L as d}from"./leaflet-src-B1vOQq_m.js";import{M as b}from"./ModalWrapper-DMihTpK2.js";import{G as g,_ as M,c as S,b as E,r as p,H as R,o as C,g as I,h as v,i as h,j as c,l as w,m as _,k as A,S as N,t as O}from"./index-dUS5mm6e.js";const P={getCurrentLocation(){return new Promise((f,l)=>{if(window.location.protocol!=="https:"&&window.location.hostname!=="localhost"&&window.location.hostname!=="127.0.0.1"){const o="出于安全原因，获取地理位置需要 HTTPS 连接。";g(o,"WARN"),l(new Error(o));return}if(!navigator.geolocation){const o="您的浏览器不支持地理位置功能。";g(o,"ERROR"),l(new Error(o));return}navigator.geolocation.getCurrentPosition(o=>{const{latitude:e,longitude:n,accuracy:u}=o.coords;g(`成功获取地理位置: Lat=${e}, Lon=${n}, Accuracy=${u}m`,"INFO"),f({latitude:e,longitude:n,accuracy:u})},o=>{let e="获取地理位置失败。";switch(o.code){case o.PERMISSION_DENIED:e="您已拒绝共享位置信息。";break;case o.POSITION_UNAVAILABLE:e="无法确定您的位置。";break;case o.TIMEOUT:e="获取位置信息超时。";break;default:e=`发生未知错误 (代码: ${o.code})。`;break}g(`地理位置错误: ${e}`,"ERROR"),l(new Error(e))},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})})}},T={class:"location-picker-content"},U={key:0,class:"status-overlay"},x={key:1,class:"status-overlay error"},B=["disabled"],V={__name:"LocationPickerModal",setup(f){const l=S(),o=E(),e=p(null),n=p("loading"),u=p(""),r=p(null);let t=null,i=null;const L=d.icon({iconUrl:"icons/marker-icon.svg",iconRetinaUrl:"icons/marker-icon.svg",shadowUrl:"icons/marker-shadow.svg",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});R(async()=>{try{const{latitude:s,longitude:a}=await P.getCurrentLocation();k([s,a]),n.value="loaded"}catch(s){u.value=s.message,n.value="error",k([39.9042,116.4074])}}),C(()=>{t&&(t.remove(),t=null)});function k(s){e.value&&!t&&(t=d.map(e.value).setView(s,16),d.tileLayer("https://{s}.ppmc.club/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(t),i=d.marker(s,{draggable:!0,icon:L}).addTo(t),r.value=i.getLatLng(),i.on("dragend",()=>{r.value=i.getLatLng()}),t.on("click",a=>{i.setLatLng(a.latlng),r.value=i.getLatLng()}))}function y(){r.value&&(o.sendMessage({location:{latitude:r.value.lat,longitude:r.value.lng,accuracy:-1}}),m())}function m(){l.hideModal()}return(s,a)=>(v(),I(b,{show:!0,title:"选择位置",onClose:m},{footer:h(()=>[c("button",{class:"btn-secondary",onClick:m},"取消"),c("button",{class:"btn-primary",onClick:y,disabled:!r.value}," 发送 ",8,B)]),default:h(()=>[c("div",T,[n.value==="loading"?(v(),w("div",U,[A(N),a[0]||(a[0]=c("p",null,"正在获取当前位置...",-1))])):_("",!0),n.value==="error"?(v(),w("div",x,[c("p",null,"定位失败: "+O(u.value),1),a[1]||(a[1]=c("p",null,"地图将显示默认位置。",-1))])):_("",!0),c("div",{id:"location-picker-map",ref_key:"mapContainerRef",ref:e},null,512)])]),_:1}))}},H=M(V,[["__scopeId","data-v-387ff04b"]]);export{H as default};
