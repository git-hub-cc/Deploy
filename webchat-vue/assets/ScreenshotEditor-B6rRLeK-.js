import{_ as O,c as j,I as P,r as s,J as x,e as $,H,o as X,K as Y,A as C,l as W,m as I,p as F,h as B,j as d,k as D,v as J,n as R,M as T,x as K,N as q}from"./index-dUS5mm6e.js";const G={class:"editor-toolbar"},Q={class:"canvas-container"},Z={__name:"ScreenshotEditor",setup(ee){const k=j(),S=P(),f=s(null),l=s(null),r=s(null),w=s(null),c=s(null),y=s(x.ui.screenshotEditor.defaultMarkColor),m=s([]),n=s(null),h=s(!1),u=s({x:0,y:0}),i=s({x:0,y:0}),U=$(()=>S.isCallActive&&!S.isFullScreenCallViewVisible);H(()=>{const t=k.modalPrefillData;t&&t.dataUrl&&V(t),window.addEventListener("mousemove",_),window.addEventListener("mouseup",L)}),X(()=>{window.removeEventListener("mousemove",_),window.removeEventListener("mouseup",L),p(!1)});function V({dataUrl:t,blob:e,originalStream:a}){const o=new Image;o.onload=()=>{r.value=o,w.value=a,Y(()=>{const v=f.value;v&&(l.value=v.getContext("2d"),v.width=o.width,v.height=o.height,M("crop"),URL.revokeObjectURL(t))})},o.src=t}function M(t){c.value=t,g()}function b(t){const e=f.value;if(!e)return{x:0,y:0};const a=e.getBoundingClientRect();return{x:(t.clientX-a.left)*(e.width/a.width),y:(t.clientY-a.top)*(e.height/a.height)}}function N(t){h.value=!0,u.value=b(t),i.value=u.value}function _(t){h.value&&(i.value=b(t),g())}function L(){if(!h.value)return;h.value=!1;const t={x:Math.min(u.value.x,i.value.x),y:Math.min(u.value.y,i.value.y),w:Math.abs(u.value.x-i.value.x),h:Math.abs(u.value.y-i.value.y)};if(t.w<5||t.h<5){c.value==="crop"&&(n.value=null),g();return}c.value==="crop"?n.value=t:c.value==="drawRect"&&m.value.push({type:"rect",...t,color:y.value}),g()}function g(){const t=f.value;if(!(!t||!l.value||!r.value)&&(l.value.clearRect(0,0,t.width,t.height),l.value.drawImage(r.value,0,0),n.value&&(l.value.fillStyle="rgba(0, 0, 0, 0.5)",l.value.fillRect(0,0,t.width,t.height),l.value.drawImage(r.value,n.value.x,n.value.y,n.value.w,n.value.h,n.value.x,n.value.y,n.value.w,n.value.h)),m.value.forEach(e=>{l.value.strokeStyle=e.color,l.value.lineWidth=x.ui.screenshotEditor.defaultMarkLineWidth,l.value.strokeRect(e.x,e.y,e.w,e.h)}),n.value&&(l.value.strokeStyle="rgba(255, 255, 255, 0.9)",l.value.lineWidth=2,l.value.strokeRect(n.value.x,n.value.y,n.value.w,n.value.h)),h.value)){const e={x:Math.min(u.value.x,i.value.x),y:Math.min(u.value.y,i.value.y),w:Math.abs(u.value.x-i.value.x),h:Math.abs(u.value.y-i.value.y)};c.value==="crop"?(l.value.strokeStyle="rgba(255, 255, 255, 0.9)",l.value.lineWidth=2,l.value.strokeRect(e.x,e.y,e.w,e.h)):c.value==="drawRect"&&(l.value.strokeStyle=y.value,l.value.lineWidth=x.ui.screenshotEditor.defaultMarkLineWidth,l.value.strokeRect(e.x,e.y,e.w,e.h))}}function p(t=!0){t&&C.emit("screenshot:editing-cancelled"),k.hideOverlayModal(),w.value&&w.value.getTracks().forEach(e=>e.stop()),r.value=null,w.value=null,m.value=[],n.value=null}function z(){p(!0)}async function A(){const t=document.createElement("canvas"),e=t.getContext("2d"),a=n.value||{x:0,y:0,w:r.value.width,h:r.value.height};t.width=a.w,t.height=a.h,e.drawImage(r.value,a.x,a.y,a.w,a.h,0,0,a.w,a.h),m.value.forEach(o=>{const v=o.x-a.x,E=o.y-a.y;e.strokeStyle=o.color,e.lineWidth=x.ui.screenshotEditor.defaultMarkLineWidth,e.strokeRect(v,E,o.w,o.h)}),t.toBlob(async o=>{if(!o){C.emit("showNotification",{message:"处理截图失败",type:"error"}),p(!0);return}const v=await q(o),E={blob:o,hash:v,name:`screenshot-${Date.now()}.png`,fileType:"image/png",size:o.size};C.emit("screenshot:editing-complete",E),p(!1)},"image/png")}return(t,e)=>F(k).activeOverlayModal==="screenshotEditor"?(B(),W("div",{key:0,class:R(["editor-backdrop",{"widget-active":U.value}])},[d("header",G,[D(T,{icon:"✂️",title:"裁剪",class:R({active:c.value==="crop"}),onClick:e[0]||(e[0]=a=>M("crop"))},null,8,["class"]),D(T,{icon:"⬜",title:"矩形标记",class:R({active:c.value==="drawRect"}),onClick:e[1]||(e[1]=a=>M("drawRect"))},null,8,["class"]),c.value==="drawRect"?J((B(),W("input",{key:0,type:"color","onUpdate:modelValue":e[2]||(e[2]=a=>y.value=a),class:"color-picker",title:"选择标记颜色"},null,512)),[[K,y.value]]):I("",!0),e[3]||(e[3]=d("div",{class:"spacer"},null,-1)),d("button",{class:"btn-confirm",onClick:A},"完成"),d("button",{class:"btn-cancel",onClick:z},"取消")]),d("div",Q,[d("canvas",{ref_key:"canvasRef",ref:f,onMousedown:N},null,544)])],2)):I("",!0)}},ae=O(Z,[["__scopeId","data-v-a549b1c1"]]);export{ae as default};
