import{_ as Ce,u as he,a as we,b as Se,c as xe,r as m,d as Ae,w as Te,e as f,o as Pe,L as Q,f as _,g as $e,h as o,i as X,j as t,n as p,k as Ne,T as Be,l as i,m as b,t as d,p as c,q as De,F as M,s as E,v as x,x as N,y as Ue,z as Ie,A,B as Me,C as Ee}from"./index-dUS5mm6e.js";import{M as Ve}from"./ModalWrapper-DMihTpK2.js";const Re={class:"settings-content"},_e={class:"modal-tabs"},Le={key:0,class:"tab-content"},je={class:"setting-item"},Oe={class:"user-id-display"},We={class:"setting-item"},Fe={class:"network-status"},ze={class:"actions-group"},Ke=["disabled"],qe=["disabled"],He=["disabled"],Ge={key:1,class:"tab-content"},Je={class:"setting-item"},Qe=["value"],Xe={class:"setting-item"},Ye=["value"],Ze=["value"],et={class:"setting-item"},tt={class:"background-controls"},st=["disabled"],nt={class:"setting-item"},ot={class:"background-controls"},it=["disabled"],lt={key:2,class:"tab-content"},at={class:"setting-item"},rt=["value"],ut=["value"],dt={class:"setting-item"},ct={class:"setting-item"},vt=["value"],mt={class:"setting-item"},pt={class:"setting-item"},gt={class:"setting-item"},ft={key:3,class:"tab-content"},bt={class:"video-preview-container"},kt={key:0,class:"preview-placeholder"},yt={key:1,class:"vu-meter-container"},Ct={class:"device-status-list"},ht={class:"device-status-item"},wt={class:"device-status-item"},St=["disabled"],xt={class:"setting-item"},At=["checked"],Tt={key:4,class:"tab-content"},Pt={key:0,class:"device-status-list"},$t={class:"device-name"},Nt=["disabled"],Bt={key:5,class:"tab-content about-tab-content"},Dt={__name:"SettingsModal",emits:["close"],setup(Ut,{emit:It}){const a=he(),B=we(),L=Se(),v=xe(),u=m("general"),j=m(null),O=m(null),r=Ae({...a.apiSettings});Te(()=>a.apiSettings,n=>{Object.assign(r,n)},{deep:!0});const T=m(!1),g=m(null),P=m(null),C=m(null),D=m(!1),$=m({}),U=m(0);let k=null,h=null,V=null,I=null;const y=m(null),Y=f(()=>!!C.value),W=f(()=>{if(!g.value)return{text:"未检测",class:"status-unknown"};switch(g.value.video.status){case"ok":return{text:"正常",class:"status-online"};case"not_found":return{text:"未找到",class:"status-offline"};case"denied":return{text:"权限被拒绝",class:"status-offline"};case"error":return{text:"错误",class:"status-offline"};default:return{text:"未知",class:"status-unknown"}}}),F=f(()=>{if(!g.value)return{text:"未检测",class:"status-unknown"};switch(g.value.audio.status){case"ok":return{text:"正常",class:"status-online"};case"not_found":return{text:"未找到",class:"status-offline"};case"denied":return{text:"权限被拒绝",class:"status-offline"};case"error":return{text:"错误",class:"status-offline"};default:return{text:"未知",class:"status-unknown"}}});function Z(n){if(!(!n||n.getAudioTracks().length===0))try{k=new(window.AudioContext||window.webkitAudioContext),h=k.createAnalyser(),h.fftSize=256,V=k.createMediaStreamSource(n),V.connect(h);const e=h.frequencyBinCount,s=new Uint8Array(e),l=()=>{I=requestAnimationFrame(l),h.getByteFrequencyData(s);const be=s.reduce((ke,ye)=>ke+ye,0)/e;U.value=Math.min(100,be*2)};l()}catch(e){console.error("Failed to initialize VU meter:",e)}}function ee(){I&&cancelAnimationFrame(I),k&&k.state!=="closed"&&k.close(),U.value=0,k=null,h=null,V=null,I=null}async function te(){T.value=!0,g.value=null,R();const n=Ee.checkDevices(),e=new Promise(l=>setTimeout(l,1e3)),[s]=await Promise.all([n,e]);if(g.value=s,s.video.stream&&(C.value=s.video.stream,P.value&&(P.value.srcObject=s.video.stream)),s.audio.status==="ok"){const l=await navigator.mediaDevices.getUserMedia({audio:!0});Z(l),s.audio.stream=l}T.value=!1}async function se(){D.value=!0,$.value={};try{const n=_.testNetwork(),e=new Promise(l=>setTimeout(l,1e3)),[s]=await Promise.all([n,e]);$.value={"STUN (公网IP发现)":s.stun,"TURN (UDP中继)":s.turnUdp,"TURN (TCP中继)":s.turnTcp,"TURN (TLS中继/443)":s.turnTls},A.emit("showNotification",{message:"网络诊断完成",type:"success"})}catch(n){A.emit("showNotification",{message:`网络诊断出错: ${n.message}`,type:"error"})}finally{D.value=!1}}function R(){var n;C.value&&(C.value.getTracks().forEach(e=>e.stop()),C.value=null),P.value&&(P.value.srcObject=null),ee(),(n=g.value)!=null&&n.audio.stream&&(g.value.audio.stream.getTracks().forEach(e=>e.stop()),g.value.audio.stream=null)}function w(n){u.value!==n&&(u.value=n,R(),g.value=null,$.value={})}Pe(()=>{R()});const ne=f(()=>{const n=a.effectiveColorScheme;return Object.fromEntries(Object.entries(a.themes).filter(([e])=>n==="dark"?e.endsWith("-深色"):e.endsWith("-浅色")))}),z=f(()=>{var n;return((n=Q[r.llmProvider])==null?void 0:n.models)||[]}),oe=f(()=>_.isWebSocketConnected.value?"已连接":"已断开"),ie=f(()=>_.isWebSocketConnected.value?"status-online":"status-offline"),K=f(()=>{const n=new Set(a.currentSpecialContacts.map(e=>e.id));return Object.keys(B.contacts).filter(e=>!n.has(e)).length}),q=f(()=>Object.keys(L.chats).length),le=()=>v.showConfirmationModal({message:"确定要删除所有手动添加的联系人吗？此操作不可逆。",onConfirm:()=>B.removeAllContacts()}),ae=()=>v.showConfirmationModal({message:"确定要清空所有聊天记录吗？此操作无法撤销。",onConfirm:()=>L.clearAllChats()}),re=()=>{v.showConfirmationModal({message:"确定要初始化应用吗？所有数据都将被删除，页面将刷新。",confirmText:"确定初始化",onConfirm:async()=>{v.isPerformingDangerousAction=!0;try{await Me.clearAllData(),localStorage.clear(),window.location.reload()}catch(n){v.isPerformingDangerousAction=!1,A.emit("showNotification",{message:`初始化失败: ${n.message}`,type:"error"})}}})},ue=n=>a.applyTheme(n.target.value,n),de=n=>a.setColorScheme(n.target.value,n),ce=()=>{navigator.clipboard.writeText(B.userId),A.emit("showNotification",{message:"用户ID已复制",type:"success"})},H=n=>{var e,s;n==="light"?(e=j.value)==null||e.click():(s=O.value)==null||s.click()},G=(n,e)=>{const s=n.target.files[0];if(s){if(!s.type.startsWith("image/")){A.emit("showNotification",{message:"请选择图片文件",type:"error"});return}if(s.size>5*1024*1024){A.emit("showNotification",{message:"图片大小不能超过 5MB",type:"warning"});return}a.setCustomBackground(s,e),n.target.value=""}},J=n=>a.removeCustomBackground(n),ve=n=>a.handleLlmProviderChange(n.target.value),S=n=>a.saveApiSetting(n,r[n]),me=n=>{a.setAiNoiseSuppression(n.target.checked)},pe=n=>{y.value&&(y.value.style.height=`${n.offsetHeight}px`)},ge=n=>{y.value&&(y.value.style.height=`${n.offsetHeight}px`)},fe=()=>{y.value&&(y.value.style.height="auto")};return(n,e)=>(o(),$e(Ve,{show:!0,title:"菜单与设置",onClose:e[24]||(e[24]=s=>n.$emit("close"))},{default:X(()=>[t("div",Re,[t("nav",_e,[t("button",{class:p({active:u.value==="general"}),onClick:e[0]||(e[0]=s=>w("general"))},"通用",2),t("button",{class:p({active:u.value==="appearance"}),onClick:e[1]||(e[1]=s=>w("appearance"))},"外观",2),t("button",{class:p({active:u.value==="api"}),onClick:e[2]||(e[2]=s=>w("api"))},"模型服务",2),t("button",{class:p({active:u.value==="media"}),onClick:e[3]||(e[3]=s=>w("media"))},"音视频",2),t("button",{class:p({active:u.value==="network"}),onClick:e[4]||(e[4]=s=>w("network"))},"网络诊断",2),t("button",{class:p({active:u.value==="about"}),onClick:e[5]||(e[5]=s=>w("about"))},"关于",2)]),t("div",{class:"tab-content-container",ref_key:"tabContainerRef",ref:y},[Ne(Be,{name:"tab-content-slide",onBeforeLeave:pe,onEnter:ge,onAfterEnter:fe},{default:X(()=>[(o(),i("div",{key:u.value,class:"tab-content-wrapper"},[u.value==="general"?(o(),i("div",Le,[t("div",je,[e[25]||(e[25]=t("label",null,"你的用户ID",-1)),t("div",Oe,[t("span",null,d(c(B).userId),1),t("button",{onClick:ce},"复制")])]),t("div",We,[e[27]||(e[27]=t("label",null,"网络状态",-1)),t("div",Fe,[e[26]||(e[26]=De(" 信令服务器: ",-1)),t("span",{class:p(ie.value)},d(oe.value),3)])]),e[29]||(e[29]=t("hr",null,null,-1)),t("div",ze,[e[28]||(e[28]=t("h3",null,"操作",-1)),t("button",{class:"btn-danger",onClick:le,disabled:K.value===0||c(v).isPerformingDangerousAction},d(c(v).isPerformingDangerousAction?"处理中...":`清空联系人 (${K.value})`),9,Ke),t("button",{class:"btn-danger",onClick:ae,disabled:q.value===0||c(v).isPerformingDangerousAction},d(c(v).isPerformingDangerousAction?"处理中...":`清空所有聊天 (${q.value})`),9,qe),t("button",{class:"btn-danger",onClick:re,disabled:c(v).isPerformingDangerousAction},d(c(v).isPerformingDangerousAction?"处理中...":"初始化应用"),9,He)])])):b("",!0),u.value==="appearance"?(o(),i("div",Ge,[t("div",Je,[e[31]||(e[31]=t("label",{for:"color-scheme-select"},"配色方案",-1)),t("select",{id:"color-scheme-select",value:c(a).colorScheme,onChange:de},[...e[30]||(e[30]=[t("option",{value:"auto"},"自动 (跟随系统)",-1),t("option",{value:"light"},"浅色模式",-1),t("option",{value:"dark"},"深色模式",-1)])],40,Qe)]),t("div",Xe,[e[32]||(e[32]=t("label",{for:"theme-select"},"主题",-1)),t("select",{id:"theme-select",value:c(a).currentThemeKey,onChange:ue},[(o(!0),i(M,null,E(ne.value,(s,l)=>(o(),i("option",{key:l,value:l},d(s.name),9,Ze))),128))],40,Ye)]),e[35]||(e[35]=t("hr",null,null,-1)),t("div",et,[e[33]||(e[33]=t("label",null,"浅色模式背景",-1)),t("div",tt,[t("button",{class:"btn-secondary",onClick:e[6]||(e[6]=s=>H("light"))},"选择图片"),t("button",{class:"btn-danger-outline",onClick:e[7]||(e[7]=s=>J("light")),disabled:!c(a).customBackgrounds.light},"移除",8,st)])]),t("div",nt,[e[34]||(e[34]=t("label",null,"深色模式背景",-1)),t("div",ot,[t("button",{class:"btn-secondary",onClick:e[8]||(e[8]=s=>H("dark"))},"选择图片"),t("button",{class:"btn-danger-outline",onClick:e[9]||(e[9]=s=>J("dark")),disabled:!c(a).customBackgrounds.dark},"移除",8,it)])]),t("input",{type:"file",ref_key:"bgInputLightRef",ref:j,onChange:e[10]||(e[10]=s=>G(s,"light")),accept:"image/*",hidden:""},null,544),t("input",{type:"file",ref_key:"bgInputDarkRef",ref:O,onChange:e[11]||(e[11]=s=>G(s,"dark")),accept:"image/*",hidden:""},null,544)])):b("",!0),u.value==="api"?(o(),i("div",lt,[t("div",at,[e[36]||(e[36]=t("label",{for:"llm-provider-select"},"大模型提供商",-1)),t("select",{id:"llm-provider-select",value:r.llmProvider,onChange:ve},[(o(!0),i(M,null,E(c(Q),(s,l)=>(o(),i("option",{key:l,value:l},d(s.label),9,ut))),128))],40,rt)]),t("div",dt,[e[37]||(e[37]=t("label",{for:"api-endpoint-input"},"API 端点",-1)),x(t("input",{id:"api-endpoint-input",type:"text","onUpdate:modelValue":e[12]||(e[12]=s=>r.apiEndpoint=s),onBlur:e[13]||(e[13]=s=>S("apiEndpoint"))},null,544),[[N,r.apiEndpoint]])]),t("div",ct,[e[38]||(e[38]=t("label",{for:"api-model-select"},"模型名称",-1)),z.value.length?x((o(),i("select",{key:0,id:"api-model-select","onUpdate:modelValue":e[14]||(e[14]=s=>r.model=s),onChange:e[15]||(e[15]=s=>S("model"))},[(o(!0),i(M,null,E(z.value,s=>(o(),i("option",{key:s.key,value:s.key},d(s.label),9,vt))),128))],544)),[[Ue,r.model]]):x((o(),i("input",{key:1,id:"api-model-input",type:"text","onUpdate:modelValue":e[16]||(e[16]=s=>r.model=s),onBlur:e[17]||(e[17]=s=>S("model")),placeholder:"输入自定义模型"},null,544)),[[N,r.model]])]),t("div",mt,[e[39]||(e[39]=t("label",{for:"api-key-input"},"API 密钥",-1)),x(t("input",{id:"api-key-input",type:"password","onUpdate:modelValue":e[18]||(e[18]=s=>r.apiKey=s),onBlur:e[19]||(e[19]=s=>S("apiKey"))},null,544),[[N,r.apiKey]])]),t("div",pt,[e[40]||(e[40]=t("label",{for:"max-tokens-input"},"最大令牌数",-1)),x(t("input",{id:"max-tokens-input",type:"number","onUpdate:modelValue":e[20]||(e[20]=s=>r.maxTokens=s),onBlur:e[21]||(e[21]=s=>S("maxTokens"))},null,544),[[N,r.maxTokens,void 0,{number:!0}]])]),t("div",gt,[e[41]||(e[41]=t("label",{for:"tts-endpoint-input"},"TTS API 端点",-1)),x(t("input",{id:"tts-endpoint-input",type:"text","onUpdate:modelValue":e[22]||(e[22]=s=>r.ttsApiEndpoint=s),onBlur:e[23]||(e[23]=s=>S("ttsApiEndpoint"))},null,544),[[N,r.ttsApiEndpoint]])])])):b("",!0),u.value==="media"?(o(),i("div",ft,[e[45]||(e[45]=t("h3",null,"设备检测",-1)),e[46]||(e[46]=t("p",null,"检查您的摄像头和麦克风是否工作正常，并已被浏览器授权访问。",-1)),t("div",{class:p(["device-check-area",{"no-video-preview":!Y.value}])},[t("div",bt,[t("video",{ref_key:"videoPreviewRef",ref:P,autoplay:"",muted:"",playsinline:"",class:"video-preview"},null,512),C.value?b("",!0):(o(),i("div",kt,d(T.value?"检测中...":"点击开始检测以预览摄像头"),1)),U.value>0?(o(),i("div",yt,[t("div",{class:"vu-meter-bar",style:Ie({width:`${U.value}%`})},null,4)])):b("",!0)]),t("div",Ct,[t("div",ht,[e[42]||(e[42]=t("span",{class:"device-name"},"摄像头",-1)),t("span",{class:p(["status-indicator",W.value.class])},d(W.value.text),3)]),t("div",wt,[e[43]||(e[43]=t("span",{class:"device-name"},"麦克风",-1)),t("span",{class:p(["status-indicator",F.value.class])},d(F.value.text),3)])])],2),t("button",{class:"btn-secondary",onClick:te,disabled:T.value},d(T.value?"正在检测...":"开始检测"),9,St),e[47]||(e[47]=t("hr",null,null,-1)),e[48]||(e[48]=t("h3",null,"通话设置",-1)),t("div",xt,[e[44]||(e[44]=t("label",{for:"ai-noise-suppression-toggle"},"AI 智能降噪",-1)),t("input",{type:"checkbox",id:"ai-noise-suppression-toggle",checked:c(a).isAiNoiseSuppressionEnabled,onChange:me,class:"toggle-switch"},null,40,At)]),e[49]||(e[49]=t("p",{class:"setting-description"},"开启后可显著消除键盘、环境等噪音（实验性功能，可能会增加CPU消耗）。",-1))])):b("",!0),u.value==="network"?(o(),i("div",Tt,[e[50]||(e[50]=t("h3",null,"网络诊断",-1)),e[51]||(e[51]=t("p",null,"测试与 STUN/TURN 服务器的连通性，这对于建立稳定的通话至关重要。",-1)),Object.keys($.value).length>0?(o(),i("div",Pt,[(o(!0),i(M,null,E($.value,(s,l)=>(o(),i("div",{class:"device-status-item",key:l},[t("span",$t,d(l),1),t("span",{class:p(["status-indicator",s==="OK"?"status-online":"status-offline"])},d(s),3)]))),128))])):b("",!0),t("button",{class:"btn-secondary",onClick:se,disabled:D.value},d(D.value?"测试中...":"开始网络测试"),9,Nt)])):b("",!0),u.value==="about"?(o(),i("div",Bt,[...e[52]||(e[52]=[t("h3",null,"关于 WebChat",-1),t("div",{class:"about-item"},[t("label",null,"项目地址"),t("a",{href:"https://github.com/git-hub-cc/WebChat",target:"_blank",rel:"noopener noreferrer"}," https://github.com/git-hub-cc/WebChat ")],-1),t("hr",null,null,-1),t("div",{class:"disclaimer-section"},[t("h4",null,"免责声明"),t("p",null,"本项目仅用于教育和演示目的。在使用或改编此代码时，请尊重任何外部 API、服务或知识产权的所有相关版权和服条款。")],-1)])])):b("",!0)]))]),_:1})],512)])]),_:1}))}},Rt=Ce(Dt,[["__scopeId","data-v-a09e8dbd"]]);export{Rt as default};
