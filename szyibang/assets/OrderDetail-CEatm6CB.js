import{_ as pe}from"./_plugin-vue_export-helper-DRcqrMy4.js";import{v as me}from"./el-loading-CDKhOZ5N.js";import{E as ve}from"./el-drawer-C4lPBeEf.js";import"./el-overlay-BgBDSbqt.js";import{E as fe}from"./el-empty-DFB2bBLd.js";import{E as _e}from"./el-image-viewer-Cfn1FMc4.js";/* empty css               *//* empty css                  */import{E as ye}from"./el-rate-CxgiWAT4.js";import{E as ge}from"./el-avatar-_8QHTF_R.js";import{E as he}from"./el-page-header-Cg0l_7Nt.js";import{A as x,B as J,a0 as ke,a1 as we,J as be,y as Ce,K as Ee,_ as Ie,p as S,e as n,o as s,f as a,g as u,H as _,G as d,N as Te,O as b,w as p,P as Se,m as F,F as U,t as m,S as Ne,T as Pe,a as De,u as Be,r as w,q as Oe,s as Ve,a2 as $e,d as Le,h as i,U as Ue,k as h,j as ze,V as z,W as M,l as B,a3 as Me,a4 as Ae,x as xe}from"./index-Bd4-WGnv.js";import{a as Je,g as Fe,b as He}from"./seeker-DggyzDn7.js";import{a as A,g as Re,f as We}from"./format-68UbSpw-.js";import{M as Ke}from"./MapContainer-BJXWeWOR.js";import{C as qe}from"./ChatWindow-vRD-qPwo.js";import{E as je}from"./index-DTydKQfe.js";import"./index-C585l_VU.js";import"./debounce-rf4AVrH1.js";import"./toNumber-BjADBi_g.js";import"./clamp-BcRwWhhj.js";import"./theme-DDUpnSH_.js";import"./el-progress-xYuBwGGD.js";import"./_baseClone-DsOkhf4F.js";/* empty css                 */import"./AudioInput-UdpFeN70.js";const Ge="timeline",Ye=x({name:"ElTimeline",props:{reverse:Boolean},setup(N,{slots:y}){const r=J("timeline");return be(Ge,y),()=>{var v,l;const t=ke((l=(v=y.default)==null?void 0:v.call(y))!=null?l:[]).filter(f=>{var C;return((C=f==null?void 0:f.type)==null?void 0:C.name)==="ElTimelineItem"});return we("ul",{class:[r.b()]},N.reverse?t.reverse():t)}}}),Qe=Ce({timestamp:{type:String,default:""},hideTimestamp:Boolean,center:Boolean,placement:{type:String,values:["top","bottom"],default:"bottom"},type:{type:String,values:["primary","success","warning","danger","info"],default:""},color:{type:String,default:""},size:{type:String,values:["normal","large"],default:"normal"},icon:{type:Ee},hollow:Boolean}),Xe=x({name:"ElTimelineItem",__name:"timeline-item",props:Qe,setup(N){const y=N,r=J("timeline-item"),v=S(()=>[r.e("node"),r.em("node",y.size||""),r.em("node",y.type||""),r.is("hollow",y.hollow)]);return(l,t)=>(s(),n("li",{class:_([d(r).b(),{[d(r).e("center")]:l.center}])},[a("div",{class:_(d(r).e("tail"))},null,2),l.$slots.dot?u("v-if",!0):(s(),n("div",{key:0,class:_(v.value),style:Te({backgroundColor:l.color})},[l.icon?(s(),b(d(F),{key:0,class:_(d(r).e("icon"))},{default:p(()=>[(s(),b(Se(l.icon)))]),_:1},8,["class"])):u("v-if",!0)],6)),l.$slots.dot?(s(),n("div",{key:1,class:_(d(r).e("dot"))},[U(l.$slots,"dot")],2)):u("v-if",!0),a("div",{class:_(d(r).e("wrapper"))},[!l.hideTimestamp&&l.placement==="top"?(s(),n("div",{key:0,class:_([d(r).e("timestamp"),d(r).is("top")])},m(l.timestamp),3)):u("v-if",!0),a("div",{class:_(d(r).e("content"))},[U(l.$slots,"default")],2),!l.hideTimestamp&&l.placement==="bottom"?(s(),n("div",{key:1,class:_([d(r).e("timestamp"),d(r).is("bottom")])},m(l.timestamp),3)):u("v-if",!0)],2)],2))}});var H=Ie(Xe,[["__file","/home/runner/work/element-plus/element-plus/packages/components/timeline/src/timeline-item.vue"]]);const Ze=Pe(Ye,{TimelineItem:H}),et=Ne(H),tt={class:"order-detail-page mobile-view-wrapper"},st={key:0,class:"detail-content"},at={class:"status-text"},ot={key:0,class:"dispute-alert mt-2"},rt={key:1,class:"status-desc"},lt={key:2,class:"status-desc"},nt={key:3,class:"status-desc"},it={key:4,class:"status-desc"},ut={key:0,class:"map-track-box"},dt={key:0,class:"responder-info flex-between"},ct={class:"info-left"},pt={class:"ml-2"},mt={class:"name"},vt={class:"info-right"},ft={class:"info-group"},_t={class:"cell"},yt={class:"value"},gt={class:"cell"},ht={class:"cell"},kt={class:"value"},wt={class:"cell block"},bt={class:"value text-desc"},Ct={key:0,class:"cell block"},Et={class:"img-list"},It={key:1,class:"info-group"},Tt={key:0},St={key:2,class:"action-bar"},Nt={class:"price"},Pt={key:3,class:"action-bar"},Dt={key:4,class:"action-bar"},Bt={class:"btn-group w-100"},Ot="https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png",Vt={__name:"OrderDetail",setup(N){const y=De(),r=Be(),v=y.params.sn,l=w(!0),t=w({order:null,responderProfile:null,orderLogs:[]}),f=w(null),C=w(!1),O=w([]),E=w(null),I=w(0),R=S(()=>t.value.order?A(t.value.order.status):{}),V=S(()=>t.value.order?Re(t.value.order.priorityLevel):{}),W=S(()=>{const o=t.value.order;return f.value?[f.value.lng,f.value.lat]:o?[o.lng,o.lat]:[120.155,30.274]}),K=S(()=>{const o=[],e=t.value.order;return e&&o.push({position:[e.lng,e.lat],title:"我的位置"}),f.value&&o.push({position:[f.value.lng,f.value.lat],title:"响应方位置",icon:"https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png"}),o});Oe(async()=>{await q();const o=t.value.order;o&&o.status>=30&&o.status<50&&(j(),P())}),Ve(()=>{E.value&&clearInterval(E.value)});async function q(){l.value=!0;try{const o=await Je(v);t.value=o}catch(o){console.error("获取订单详情失败",o)}finally{l.value=!1}}async function j(){var T;const o=(T=t.value.order)==null?void 0:T.responderId;if(!o)return;I.value=0;const e=async()=>{if(I.value>5){console.warn("连续多次获取对方位置失败，已停止轮询。"),E.value&&clearInterval(E.value),B.warning("暂时无法获取对方位置");return}try{const g=await Me(o);g&&typeof g.lat=="number"&&typeof g.lng=="number"?(f.value=g,I.value=0):I.value++,await P()}catch(g){console.warn("轮询位置/消息失败",g),I.value++}};await e(),E.value=setInterval(e,1e4)}function G(){const o=Fe(v);window.open(o,"_self")}function Y(){xe.confirm("确认响应方已完成服务？确认后资金将结算给对方。","确认完成",{type:"success"}).then(async()=>{await He(v),B.success("订单已完成，请对服务进行评价"),r.replace(`/seeker/evaluation/${v}`)}).catch(()=>{})}function Q(){r.push(`/seeker/evaluation/${v}`)}async function X(){await P(),C.value=!0}async function P(){const o=t.value.order;if(o)try{O.value=await $e(o.id)}catch(e){console.error("加载聊天记录失败",e)}}async function Z(o){const e=t.value.order;if(!(!e||!e.responderId))try{await Ae({receiverId:e.responderId,orderId:e.id,...o}),await P()}catch{B.error("消息发送失败")}}function ee(){r.push({path:"/dispute/apply",query:{orderId:t.value.order.id}})}function te(){t.value.order.caseId?r.push(`/dispute/detail/${t.value.order.caseId}`):B.info("正在同步案件信息，请稍后从订单列表查看")}return(o,e)=>{var $,L;const T=he,g=Le("Warning"),se=F,ae=ge,oe=ye,k=ze,re=je,le=_e,ne=et,ie=Ze,ue=fe,de=ve,ce=me;return s(),n("div",tt,[i(T,{onBack:e[0]||(e[0]=c=>o.$router.back()),title:"订单详情",class:"page-header"}),t.value.order?Ue((s(),n("div",st,[a("div",{class:_(["status-card","status-"+t.value.order.status])},[a("div",at,m(R.value.text),1),t.value.order.hasDispute?(s(),n("div",ot,[i(se,null,{default:p(()=>[i(g)]),_:1}),e[3]||(e[3]=h(" 该订单正在进行纠纷处理 ",-1))])):t.value.order.status===10?(s(),n("div",rt,"请在 15 分钟内完成支付")):t.value.order.status===20?(s(),n("div",lt,"正在为您寻找附近的响应方...")):t.value.order.status===30?(s(),n("div",nt,"响应方已接单，正在前往")):t.value.order.status===55?(s(),n("div",it,"订单已完成，感谢您的使用")):u("",!0)],2),t.value.order.status>=30&&t.value.order.status<50?(s(),n("div",ut,[i(Ke,{height:"200px",center:W.value,markers:K.value},null,8,["center","markers"]),t.value.responderProfile?(s(),n("div",dt,[a("div",ct,[i(ae,{size:40,src:(($=t.value.responderProfile.user)==null?void 0:$.avatarUrl)||Ot},null,8,["src"]),a("div",pt,[a("div",mt,m(((L=t.value.responderProfile.user)==null?void 0:L.nickname)||"匿名师傅"),1),i(oe,{modelValue:t.value.responderProfile.ratingAvg,"onUpdate:modelValue":e[1]||(e[1]=c=>t.value.responderProfile.ratingAvg=c),disabled:"",size:"small"},null,8,["modelValue"])])]),a("div",vt,[i(k,{circle:"",type:"success",icon:"Phone",disabled:""}),i(k,{circle:"",type:"primary",icon:"ChatDotRound",onClick:X})])])):u("",!0)])):u("",!0),a("div",ft,[e[9]||(e[9]=a("div",{class:"group-title"},"需求详情",-1)),a("div",_t,[e[4]||(e[4]=a("span",{class:"label"},"服务类型",-1)),a("span",yt,m(t.value.order.categoryName),1)]),a("div",gt,[e[5]||(e[5]=a("span",{class:"label"},"紧急程度",-1)),i(re,{size:"small",type:V.value.type},{default:p(()=>[h(m(V.value.text),1)]),_:1},8,["type"])]),a("div",ht,[e[6]||(e[6]=a("span",{class:"label"},"情况描述",-1)),a("span",kt,m(t.value.order.title),1)]),a("div",wt,[e[7]||(e[7]=a("div",{class:"label mb-2"},"详细内容",-1)),a("div",bt,m(t.value.order.contentText),1)]),t.value.order.imageUrls&&JSON.parse(t.value.order.imageUrls).length>0?(s(),n("div",Ct,[e[8]||(e[8]=a("div",{class:"label mb-2"},"现场照片",-1)),a("div",Et,[(s(!0),n(z,null,M(JSON.parse(t.value.order.imageUrls),(c,D)=>(s(),b(le,{key:D,src:c,"preview-src-list":JSON.parse(t.value.order.imageUrls),fit:"cover",class:"img-item",lazy:""},null,8,["src","preview-src-list"]))),128))])])):u("",!0)]),t.value.orderLogs&&t.value.orderLogs.length>0?(s(),n("div",It,[e[10]||(e[10]=a("div",{class:"group-title"},"订单进度",-1)),i(ie,null,{default:p(()=>[(s(!0),n(z,null,M(t.value.orderLogs,(c,D)=>(s(),b(ne,{key:D,timestamp:d(We)(c.logTime),type:D===0?"primary":""},{default:p(()=>[h(m(c.operatorInfo)+" ",1),c.toStatus?(s(),n("span",Tt," (状态变为: "+m(d(A)(c.toStatus).text)+")",1)):u("",!0)]),_:2},1032,["timestamp","type"]))),128))]),_:1})])):u("",!0),t.value.order.status===10?(s(),n("div",St,[a("div",Nt,"¥ "+m(t.value.order.totalAmount),1),i(k,{type:"danger",onClick:G},{default:p(()=>[...e[11]||(e[11]=[h("立即支付",-1)])]),_:1})])):u("",!0),t.value.order.status===50?(s(),n("div",Pt,[e[13]||(e[13]=a("div",{class:"tips"},"响应方已完成服务，请确认",-1)),i(k,{type:"primary",onClick:Y},{default:p(()=>[...e[12]||(e[12]=[h("确认完成",-1)])]),_:1})])):u("",!0),t.value.order.status===55?(s(),n("div",Dt,[a("div",Bt,[t.value.order.hasDispute?(s(),b(k,{key:0,type:"warning",plain:"",class:"flex-1",onClick:te},{default:p(()=>[...e[14]||(e[14]=[h(" 纠纷进度 ",-1)])]),_:1})):(s(),b(k,{key:1,type:"danger",plain:"",class:"flex-1",onClick:ee},{default:p(()=>[...e[15]||(e[15]=[h(" 申请追责 ",-1)])]),_:1})),i(k,{type:"success",plain:"",onClick:Q,class:"flex-1"},{default:p(()=>[...e[16]||(e[16]=[h("去评价",-1)])]),_:1})])])):u("",!0)])),[[ce,l.value]]):l.value?u("",!0):(s(),b(ue,{key:1,description:"订单信息加载失败"})),i(de,{modelValue:C.value,"onUpdate:modelValue":e[2]||(e[2]=c=>C.value=c),title:"与响应方沟通",direction:"btt",size:"80%","with-header":!0},{default:p(()=>[i(qe,{messages:O.value,onSend:Z},null,8,["messages"])]),_:1},8,["modelValue"])])}}},ls=pe(Vt,[["__scopeId","data-v-75e5a877"]]);export{ls as default};
