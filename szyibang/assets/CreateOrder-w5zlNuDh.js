import{_ as ue}from"./_plugin-vue_export-helper-DRcqrMy4.js";import{E as me}from"./el-dialog-pCIKPT3_.js";import"./el-overlay-Czg3P4MJ.js";import{E as pe,a as ce}from"./el-form-item-BAbr5JjY.js";/* empty css                 */import{E as fe}from"./el-input-number-G37_5v12.js";import{E as ve}from"./el-progress-BkGY-C7m.js";import{E as ge,a as ye,b as _e}from"./el-radio-button-nIMF2d17.js";/* empty css                  *//* empty css               */import{E as be}from"./el-page-header-Do0TP4tY.js";import{$ as Ve,u as xe,a as ke,r as d,c as j,p as U,D as Ae,q as we,Y as Ie,d as T,e as c,h as a,f as n,g as D,k as i,w as l,m as Ee,E as Le,j as Ce,o as p,V as J,W as Ne,O as Ue,t as u,H as Te,G as W,l as w,v as Se}from"./index-Dczg_W-s.js";import{u as Fe}from"./location-Cz1mA6wL.js";import{c as Me,g as Pe}from"./seeker-CbWtYpzn.js";import{g as qe}from"./format-68UbSpw-.js";import{a as Be,M as Re}from"./MapContainer-1ZqF2xoe.js";import{A as De}from"./AudioInput-B-vpLDmh.js";import{E as $e}from"./index-CsPiBT-M.js";import"./index-D5yFMpEK.js";import"./refs-D6FW0B1r.js";import"./castArray-Bkbd9iUu.js";import"./_baseClone-DlauArLD.js";import"./omit-CXgNd_Yj.js";import"./theme-CFdUErEm.js";function ze(S,I){const V=new FormData;return S&&V.append("text",S),I&&V.append("voiceFile",I),Ve({url:"/ai/parse",method:"post",data:V,headers:{"Content-Type":"multipart/form-data"}})}const Oe={class:"create-order-page mobile-view-wrapper"},He={class:"scroll-content"},Ge={class:"ai-input-section"},Xe={class:"section-title"},je={class:"voice-bar mt-20 flex-center"},Je={key:0,class:"loading-tips"},We={key:0,class:"ai-tip-text text-success"},Ye={key:0,class:"tip-text ml-2"},he={key:1,class:"tip-text ml-2 text-danger"},Ke={class:"bottom-bar"},Qe={class:"price"},Ze={class:"order-summary"},et={class:"summary-item"},tt={class:"value"},at={class:"summary-item"},lt={class:"summary-item"},ot={class:"value"},st={class:"summary-item"},nt={class:"value"},rt={class:"total-price"},it={key:1,class:"text-success"},dt={class:"dialog-footer"},ut={class:"mt-20 text-center"},mt={key:0,class:"mb-10 text-gray text-sm"},pt={__name:"CreateOrder",setup(S){const I=xe(),V=ke(),m=Fe(),y=d([]),F=d(null),$=d([]),E=d(!1),x=d(!1),M=d(!1),P=d(50),k=d(""),_=d(!1),q=d(!1),L=d(!1),t=j({categoryId:Number(V.query.categoryId)||null,priorityLevel:3,title:"",contentText:"",imageUrls:[],addressName:m.address,lat:m.latitude,lng:m.longitude,totalAmount:50}),f=j({lat:0,lng:0,address:""}),Y={categoryId:[{required:!0,message:"请选择服务类型",trigger:"change"}],title:[{required:!0,message:"请输入标题",trigger:"blur"}],addressName:[{required:!0,message:"请选择地址",trigger:"change"}],totalAmount:[{required:!0,message:"请输入金额",trigger:"blur"}]},z=U(()=>t.priorityLevel===1),B=U(()=>{if(t.priorityLevel===1)return 0;const o=y.value.find(e=>e.id===t.categoryId);return o?o.minPrice:0}),h=U(()=>{const o=y.value.find(e=>e.id===t.categoryId);return o?o.catName:"未知类目"}),O=U(()=>qe(t.priorityLevel));Ae(()=>t.priorityLevel,o=>{o===1?(P.value=t.totalAmount,t.totalAmount=0):t.totalAmount=P.value>0?P.value:B.value}),we(async()=>{try{y.value=await Ie(),!t.categoryId&&y.value.length>0&&(t.categoryId=y.value[0].id)}catch(o){console.error("获取类目失败",o)}if(t.addressName==="定位中..."||!t.addressName){const o=await Be(m.longitude,m.latitude);t.addressName=o,m.updateLocation(m.latitude,m.longitude,o)}});async function K(){F.value&&await F.value.validate(o=>{o?x.value=!0:w.warning("请完善表单信息")})}async function Q(){M.value=!0;try{const o=await Me({...t,imageUrls:JSON.stringify(t.imageUrls)});if(x.value=!1,t.totalAmount>0){w.success("发布成功！即将跳转支付...");const e=Pe(o);window.open(e,"_self")}else w.success("发布成功！已为您紧急通知附近的响应方！"),I.replace(`/seeker/order-detail/${o}`)}catch(o){console.error("订单创建失败",o)}finally{M.value=!1}}async function Z(o){await H(null,o)}async function H(o,e){const v=k.value;if(!v&&!e){w.warning("请输入内容或进行录音");return}_.value=!0,L.value=!1;try{const r=await ze(v,e);r.categoryId&&(t.categoryId=r.categoryId),r.priorityLevel&&(t.priorityLevel=r.priorityLevel),r.title&&(t.title=r.title),r.contentText&&(t.contentText=r.contentText),r.correctedText&&(k.value=r.correctedText),r.address&&r.address.length>2&&(t.addressName=r.address,L.value=!0),q.value=!0,setTimeout(()=>q.value=!1,1500),w.success("AI 已智能填单完成")}catch(r){console.error("AI解析失败:",r)}finally{_.value=!1}}async function ee(o){const e=new FormData;e.append("file",o.file);try{const v=await Se(e);t.imageUrls.push(v)}catch(v){console.error("图片上传失败:",v)}}function te(o){f.lat=o.lat,f.lng=o.lng,f.address=o.address}function ae(){t.lat=f.lat,t.lng=f.lng,t.addressName=f.address,L.value=!1,E.value=!1}return(o,e)=>{const v=be,r=T("Cpu"),C=Ee,A=$e,N=Le,b=Ce,le=T("Loading"),oe=ye,G=ge,g=pe,R=_e,se=T("Plus"),ne=ve,re=T("MagicStick"),ie=fe,de=ce,X=me;return p(),c("div",Oe,[a(v,{onBack:e[0]||(e[0]=s=>o.$router.back()),title:"发布需求",class:"page-header"}),n("div",He,[n("div",Ge,[n("div",Xe,[a(C,null,{default:l(()=>[a(r)]),_:1}),e[15]||(e[15]=i(" 智能填单 ",-1)),a(A,{size:"small",type:"success",effect:"plain",class:"ml-2"},{default:l(()=>[...e[14]||(e[14]=[i("AI 辅助",-1)])]),_:1})]),a(N,{modelValue:k.value,"onUpdate:modelValue":e[1]||(e[1]=s=>k.value=s),type:"textarea",rows:3,placeholder:"请描述您的紧急情况，例如：'家里水管爆了，很急，在文三路XX小区'",resize:"none",disabled:_.value},null,8,["modelValue","disabled"]),n("div",je,[a(De,{onFinish:Z}),a(b,{type:"primary",plain:"",size:"small",class:"ml-3 manual-ai-btn",loading:_.value,disabled:!k.value&&!_.value,onClick:e[2]||(e[2]=s=>H(null,null))},{default:l(()=>[...e[16]||(e[16]=[i(" 文字识别 ",-1)])]),_:1},8,["loading","disabled"])]),_.value?(p(),c("div",Je,[a(C,{class:"is-loading"},{default:l(()=>[a(le)]),_:1}),e[17]||(e[17]=n("span",null,"正在智能分析语音意图...",-1))])):D("",!0)]),a(de,{ref_key:"formRef",ref:F,model:t,rules:Y,"label-position":"top",class:Te(["main-form",{"highlight-anim":q.value}])},{default:l(()=>[a(g,{label:"需要什么帮助？",prop:"categoryId"},{default:l(()=>[a(G,{modelValue:t.categoryId,"onUpdate:modelValue":e[3]||(e[3]=s=>t.categoryId=s)},{default:l(()=>[(p(!0),c(J,null,Ne(y.value,s=>(p(),Ue(oe,{key:s.id,value:s.id},{default:l(()=>[i(u(s.catName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(g,{label:"紧急程度",prop:"priorityLevel"},{default:l(()=>[a(G,{modelValue:t.priorityLevel,"onUpdate:modelValue":e[4]||(e[4]=s=>t.priorityLevel=s)},{default:l(()=>[a(R,{value:1,class:"priority-radio red"},{default:l(()=>[a(A,{type:"danger",effect:"dark"},{default:l(()=>[...e[18]||(e[18]=[i("一级 (危及安全)",-1)])]),_:1})]),_:1}),a(R,{value:2,class:"priority-radio yellow"},{default:l(()=>[a(A,{type:"warning",effect:"dark"},{default:l(()=>[...e[19]||(e[19]=[i("二级 (影响生活)",-1)])]),_:1})]),_:1}),a(R,{value:3,class:"priority-radio blue"},{default:l(()=>[a(A,{type:"primary",effect:"dark"},{default:l(()=>[...e[20]||(e[20]=[i("三级 (一般急事)",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),a(g,{label:"情况摘要",prop:"title"},{default:l(()=>[a(N,{modelValue:t.title,"onUpdate:modelValue":e[5]||(e[5]=s=>t.title=s),placeholder:"如：水管爆裂"},null,8,["modelValue"])]),_:1}),a(g,{label:"详细描述",prop:"contentText"},{default:l(()=>[a(N,{modelValue:t.contentText,"onUpdate:modelValue":e[6]||(e[6]=s=>t.contentText=s),type:"textarea",rows:4,placeholder:"请补充详细细节..."},null,8,["modelValue"])]),_:1}),a(g,{label:"现场照片"},{default:l(()=>[a(ne,{"file-list":$.value,"onUpdate:fileList":e[7]||(e[7]=s=>$.value=s),action:"#","list-type":"picture-card","http-request":ee,limit:3},{default:l(()=>[a(C,null,{default:l(()=>[a(se)]),_:1})]),_:1},8,["file-list"])]),_:1}),a(g,{label:"事发地点",prop:"addressName"},{default:l(()=>[a(N,{modelValue:t.addressName,"onUpdate:modelValue":e[9]||(e[9]=s=>t.addressName=s),placeholder:"点击图标选择定位",readonly:""},{append:l(()=>[a(b,{icon:"Location",onClick:e[8]||(e[8]=s=>E.value=!0)})]),_:1},8,["modelValue"]),L.value?(p(),c("div",We,[a(C,null,{default:l(()=>[a(re)]),_:1}),e[21]||(e[21]=i(" AI已自动提取地址，请核对 ",-1))])):D("",!0)]),_:1}),a(g,{label:"预估酬金 (元)",prop:"totalAmount"},{default:l(()=>[a(ie,{modelValue:t.totalAmount,"onUpdate:modelValue":e[10]||(e[10]=s=>t.totalAmount=s),min:B.value,precision:2,step:10,disabled:z.value},null,8,["modelValue","min","disabled"]),z.value?(p(),c("span",he,"高危求助开启公益模式，无需支付")):(p(),c("span",Ye,"起步价: ¥"+u(B.value),1))]),_:1})]),_:1},8,["model","class"])]),n("div",Ke,[n("div",Qe,[e[22]||(e[22]=i(" 预估: ",-1)),n("span",null,"¥ "+u(t.totalAmount.toFixed(2)),1)]),a(b,{type:"primary",size:"large",class:"confirm-btn",onClick:K},{default:l(()=>[i(u(t.totalAmount>0?"核对并发布":"直接发布"),1)]),_:1})]),a(X,{modelValue:x.value,"onUpdate:modelValue":e[12]||(e[12]=s=>x.value=s),title:"确认订单详情",width:"90%",class:"order-confirm-dialog","append-to-body":"",center:""},{footer:l(()=>[n("div",dt,[a(b,{onClick:e[11]||(e[11]=s=>x.value=!1)},{default:l(()=>[...e[29]||(e[29]=[i("返回修改",-1)])]),_:1}),a(b,{type:"primary",loading:M.value,onClick:Q},{default:l(()=>[i(u(t.totalAmount>0?"确认无误，去支付":"确认无误，立即发布"),1)]),_:1},8,["loading"])])]),default:l(()=>[n("div",Ze,[n("div",et,[e[23]||(e[23]=n("span",{class:"label"},"服务类型：",-1)),n("span",tt,u(h.value),1)]),n("div",at,[e[24]||(e[24]=n("span",{class:"label"},"紧急程度：",-1)),a(A,{size:"small",type:O.value.type},{default:l(()=>[i(u(O.value.text),1)]),_:1},8,["type"])]),n("div",lt,[e[25]||(e[25]=n("span",{class:"label"},"需求标题：",-1)),n("span",ot,u(t.title),1)]),n("div",st,[e[26]||(e[26]=n("span",{class:"label"},"地点：",-1)),n("span",nt,u(t.addressName),1)]),e[28]||(e[28]=n("div",{class:"divider"},null,-1)),n("div",rt,[t.totalAmount>0?(p(),c(J,{key:0},[e[27]||(e[27]=i(" 应付总额：",-1)),n("span",null,"¥ "+u(t.totalAmount.toFixed(2)),1)],64)):(p(),c("span",it,"公益订单，无需支付"))])])]),_:1},8,["modelValue"]),a(X,{modelValue:E.value,"onUpdate:modelValue":e[13]||(e[13]=s=>E.value=s),title:"选择地点",width:"90%","append-to-body":""},{default:l(()=>[a(Re,{height:"300px",clickable:"",center:[W(m).longitude,W(m).latitude],onMapClick:te},null,8,["center"]),n("div",ut,[f.address?(p(),c("p",mt,"已选位置: "+u(f.address),1)):D("",!0),a(b,{type:"primary",onClick:ae},{default:l(()=>[...e[30]||(e[30]=[i("确认选择",-1)])]),_:1})])]),_:1},8,["modelValue"])])}}},Bt=ue(pt,[["__scopeId","data-v-c6531f7e"]]);export{Bt as default};
