import{u as w}from"./theme-DDUpnSH_.js";import{_ as y}from"./_plugin-vue_export-helper-DRcqrMy4.js";import{a7 as A,q as M,D as u,s as k,e as h,N as P,o as I}from"./index-Bd4-WGnv.js";function v(a,e={}){return window.AMap?new AMap.Map(a,{resizeEnable:!0,zoom:e.zoom||14,center:e.center||[120.15515,30.27415],mapStyle:"amap://styles/normal"}):(console.error("高德地图 JS API 未加载"),null)}function S(a,e){if(!a||!e.position)return null;const n={position:new AMap.LngLat(e.position[0],e.position[1]),title:e.title||"",offset:new AMap.Pixel(-13,-30)};e.icon?n.icon=new AMap.Icon({size:new AMap.Size(40,40),image:e.icon,imageSize:new AMap.Size(40,40)}):e.content&&(n.content=e.content);const s=new AMap.Marker(n);return a.add(s),s}async function x(){try{const a=await fetch("http://ip-api.com/json/?lang=zh-CN");if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const e=await a.json();if(e.status==="success")return{lat:e.lat,lng:e.lon};throw new Error("IP定位API返回状态非成功")}catch(a){throw console.error("第三方IP定位失败:",a),a}}function $(){return new Promise((a,e)=>{if(!window.AMap){e(new Error("地图API未加载"));return}AMap.plugin("AMap.Geolocation",function(){new AMap.Geolocation({enableHighAccuracy:!0,timeout:5e3,buttonOffset:new AMap.Pixel(10,20),zoomToAccuracy:!0}).getCurrentPosition(async function(s,i){if(s==="complete")a({lat:i.position.lat,lng:i.position.lng,address:i.formattedAddress||"未知位置"});else{console.warn("高德定位失败，尝试使用第三方IP定位...",i.message);try{const r=await x();let t=`IP定位大致位置 (经度${r.lng.toFixed(2)}, 纬度${r.lat.toFixed(2)})`;try{t=await f(r.lng,r.lat)}catch(l){console.warn("IP坐标逆地理编码失败，使用默认描述",l)}a({lat:r.lat,lng:r.lng,address:t})}catch(r){const t="定位彻底失败: "+i.message+(r?` (IP定位也失败: ${r.message})`:"");e(new Error(t))}}})})})}function f(a,e){return new Promise((n,s)=>{if(!window.AMap){n(`经度${a.toFixed(4)}, 纬度${e.toFixed(4)}`);return}AMap.plugin("AMap.Geocoder",function(){new AMap.Geocoder({radius:1e3,extensions:"all"}).getAddress([a,e],function(r,t){r==="complete"&&t.info==="OK"?t.regeocode?n(t.regeocode.formattedAddress):n("未知地点"):s(new Error("逆地理编码失败"))})})})}const z={__name:"MapContainer",props:{height:{type:String,default:"300px"},center:{type:Array,default:()=>[120.15515,30.27415]},markers:{type:Array,default:()=>[]},clickable:{type:Boolean,default:!1}},emits:["map-click","marker-click"],setup(a,{emit:e}){const n=a,s=e,i=w(),r=`amap-container-${Date.now()}-${Math.random().toString(36).slice(2)}`,t=A(null),l=[];M(()=>{t.value=v(r,{center:n.center,zoom:14,mapStyle:i.isDark?"amap://styles/dark":"amap://styles/normal"}),t.value&&(n.clickable&&t.value.on("click",async o=>{const c=o.lnglat.getLat(),d=o.lnglat.getLng();let p="";try{p=await f(d,c)}catch(g){console.error(g),p="未知位置"}s("map-click",{lat:c,lng:d,address:p})}),m())}),u(()=>i.isDark,o=>{if(t.value){const c=o?"amap://styles/dark":"amap://styles/normal";t.value.setMapStyle(c)}}),u(()=>n.markers,()=>{m()},{deep:!0}),u(()=>n.center,o=>{t.value&&Array.isArray(o)&&o.length===2&&typeof o[0]=="number"&&typeof o[1]=="number"?t.value.setCenter(o):console.warn("[MapContainer] Received an invalid center prop:",o)});function m(){t.value&&(t.value.remove(l),l.length=0,n.markers.forEach(o=>{const c=S(t.value,o);c&&(c.on("click",()=>{s("marker-click",o)}),l.push(c))}))}return k(()=>{t.value&&t.value.destroy()}),(o,c)=>(I(),h("div",{id:r,class:"map-wrapper",style:P({height:a.height})},null,4))}},C=y(z,[["__scopeId","data-v-39f9c9dc"]]);export{C as M,f as a,$ as g};
